///
/// HybridNitroOrbComponent.mm
/// This file was generated by nitrogen. DO NOT MODIFY THIS FILE.
/// https://github.com/mrousavy/nitro
/// Copyright Â© 2025 Marc Rousavy @ Margelo
///

#import "HybridNitroOrbComponent.hpp"
#import <memory>
#import <react/renderer/componentregistry/ComponentDescriptorProvider.h>
#import <React/RCTViewComponentView.h>
#import <React/RCTComponentViewFactory.h>
#import <React/UIView+ComponentViewProtocol.h>
#import <NitroModules/NitroDefines.hpp>
#import <UIKit/UIKit.h>

#import "HybridNitroOrbSpecSwift.hpp"
#import "NitroOrb-Swift-Cxx-Umbrella.hpp"

using namespace facebook;
using namespace margelo::nitro::nitroorb;
using namespace margelo::nitro::nitroorb::views;

/**
 * Represents the React Native View holder for the Nitro "NitroOrb" HybridView.
 */
@interface HybridNitroOrbComponent: RCTViewComponentView
@end

@implementation HybridNitroOrbComponent {
  std::shared_ptr<HybridNitroOrbSpecSwift> _hybridView;
}

+ (void) load {
  [super load];
  [RCTComponentViewFactory.currentComponentViewFactory registerComponentViewClass:[HybridNitroOrbComponent class]];
}

+ (react::ComponentDescriptorProvider) componentDescriptorProvider {
  return react::concreteComponentDescriptorProvider<HybridNitroOrbComponentDescriptor>();
}

- (instancetype) init {
  if (self = [super init]) {
    std::shared_ptr<HybridNitroOrbSpec> hybridView = NitroOrb::NitroOrbAutolinking::createNitroOrb();
    _hybridView = std::dynamic_pointer_cast<HybridNitroOrbSpecSwift>(hybridView);
    [self updateView];
  }
  return self;
}

- (void) updateView {
  // 1. Get Swift part
  NitroOrb::HybridNitroOrbSpec_cxx& swiftPart = _hybridView->getSwiftPart();

  // 2. Get UIView*
  void* viewUnsafe = swiftPart.getView();
  UIView* view = (__bridge_transfer UIView*) viewUnsafe;

  // 3. Update RCTViewComponentView's [contentView]
  [self setContentView:view];
}

- (void) updateProps:(const std::shared_ptr<const react::Props>&)props
            oldProps:(const std::shared_ptr<const react::Props>&)oldProps {
  // 1. Downcast props
  const auto& newViewPropsConst = *std::static_pointer_cast<HybridNitroOrbProps const>(props);
  auto& newViewProps = const_cast<HybridNitroOrbProps&>(newViewPropsConst);
  NitroOrb::HybridNitroOrbSpec_cxx& swiftPart = _hybridView->getSwiftPart();

  // 2. Update each prop individually
  swiftPart.beforeUpdate();

  // preset: optional
  if (newViewProps.preset.isDirty) {
    swiftPart.setPreset(newViewProps.preset.value);
    newViewProps.preset.isDirty = false;
  }
  // speed: optional
  if (newViewProps.speed.isDirty) {
    swiftPart.setSpeed(newViewProps.speed.value);
    newViewProps.speed.isDirty = false;
  }
  // glowColor: optional
  if (newViewProps.glowColor.isDirty) {
    swiftPart.setGlowColor(newViewProps.glowColor.value);
    newViewProps.glowColor.isDirty = false;
  }
  // backgroundColors: optional
  if (newViewProps.backgroundColors.isDirty) {
    swiftPart.setBackgroundColors(newViewProps.backgroundColors.value);
    newViewProps.backgroundColors.isDirty = false;
  }
  // particleColor: optional
  if (newViewProps.particleColor.isDirty) {
    swiftPart.setParticleColor(newViewProps.particleColor.value);
    newViewProps.particleColor.isDirty = false;
  }
  // showWavyBlobs: optional
  if (newViewProps.showWavyBlobs.isDirty) {
    swiftPart.setShowWavyBlobs(newViewProps.showWavyBlobs.value);
    newViewProps.showWavyBlobs.isDirty = false;
  }
  // showParticles: optional
  if (newViewProps.showParticles.isDirty) {
    swiftPart.setShowParticles(newViewProps.showParticles.value);
    newViewProps.showParticles.isDirty = false;
  }
  // showGlowEffects: optional
  if (newViewProps.showGlowEffects.isDirty) {
    swiftPart.setShowGlowEffects(newViewProps.showGlowEffects.value);
    newViewProps.showGlowEffects.isDirty = false;
  }
  // showShadow: optional
  if (newViewProps.showShadow.isDirty) {
    swiftPart.setShowShadow(newViewProps.showShadow.value);
    newViewProps.showShadow.isDirty = false;
  }
  // coreGlowItensity: optional
  if (newViewProps.coreGlowItensity.isDirty) {
    swiftPart.setCoreGlowItensity(newViewProps.coreGlowItensity.value);
    newViewProps.coreGlowItensity.isDirty = false;
  }

  swiftPart.afterUpdate();

  // 3. Update hybridRef if it changed
  if (newViewProps.hybridRef.isDirty) {
    // hybridRef changed - call it with new this
    const auto& maybeFunc = newViewProps.hybridRef.value;
    if (maybeFunc.has_value()) {
      maybeFunc.value()(_hybridView);
    }
    newViewProps.hybridRef.isDirty = false;
  }

  // 4. Continue in base class
  [super updateProps:props oldProps:oldProps];
}

@end
